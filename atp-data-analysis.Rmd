---
title: "ATP Data Analysis"
authors: Matija Pavlović, Barbara Pašalić, Jelena Kulišić, Marko Miljković
date: "19.1.2024."
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Instalacija potrebnih paketa.

```{r}
# install.packages("dplyr")
# install.packages("lubridate")
# install.packages("ggplot2")
# install.packages("caret")
# install.packages("nortest")
# install.packages("fastDummies")
```

Učitavanje biblioteka.

```{r message=FALSE}
library(dplyr)
library(lubridate)
library(ggplot2)
library(caret)
library(nortest)
library(fastDummies)
```

Učitavanje i opis podataka

```{r}
all_matches <- data.frame()
for (year in 1991:2023) {
  file_name <- paste0("dataset/atp_matches_", year, ".csv")
  matches_year <- read.csv(file_name, stringsAsFactors = FALSE)
  all_matches <- rbind(all_matches, matches_year)
}

dim(all_matches)
```
Skup podataka sadrži informacije o 104682 teniska meča održana od 1991. do 2023. godine uključivo. Svaki meč opisan je s 49 ispod navedenih značajki:

```{r}
names(all_matches)
```

## Zadatak 1. Kakva je distribucija mečeva na specifičnim podlogama u različitim godišnjim dobima?

```{r echo=FALSE}
t1 <- all_matches %>%
  filter(!is.na(surface) & !is.na(tourney_date) & surface != "")

t1 <- select(t1, surface, tourney_date)

t1$tourney_date <- as.Date(as.character(t1$tourney_date), format = "%Y%m%d", origin = "1970-01-01")
t1$month <- month(t1$tourney_date)
t1$season <- case_when(
  t1$month %in% c(3, 4, 5) ~ "Spring",
  t1$month %in% c(6, 7, 8) ~ "Summer",
  t1$month %in% c(9, 10, 11) ~ "Fall",
  t1$month %in% c(12, 1, 2) ~ "Winter",
  TRUE ~ "Unknown"
)

surface_counts <- table(t1$season, t1$surface)
surface_counts_df <- as.data.frame(surface_counts)
names(surface_counts_df) <- c("Season", "Surface", "Frequency")

ggplot(t1, aes(x = season, fill = factor(season))) +
  geom_bar() +
  facet_wrap(~ surface, scales = "free") +
  labs(title = "Season Frequencies for Each Surface", x = "Season", y = "Frequency") +
  theme_minimal()
```

U prvom histogramu prikazana je raspodjela teniskih mečeva prema godišnjim dobima na podlozi od tepiha. Podloga od tepiha najmanje je korištena podloga za igranje mečeva. Najčešće se podloga od tepiha koristila u jesen, dosta rjeđe zimi, zatim na proljeće, a najmanje se mečeva na podlozi od tepiha igra na ljeto. 

Sljedeći histogram predstavlja raspodjelu mečeva prema godišnjim dobima na zemljanoj podlozi. Mečevi na zemlji najčešće se igraju u proljetnom dijelu sezone. Dosta manje mečeva igra se na ljeto zatim otprilike podjednako na jesen i zimi. 

Treći histogram opisuje distribuciju teniskih mečeva prema godišnjim dobima na travi. Teniski mečevi na travi igraju se uglavnom ljeti, a svega nekoliko mečeva igra se u preostalim godišnjim dobima. 

U posljednjem histogramu promatrana je raspodjela mečeva prema godišnjim dobima na tvrdoj podlozi. Sveukupno najviše mečeva igra se na tvrdoj podlozi te je raspodjela prema godišnjim dobima manje izražena nego kod drugih podloga. Najviše mečeva na tvrdoj podlozi održava se zimi, zatim u ljeto pa na jesen te najmanje u proljetnom dijelu sezone.

```{r echo=FALSE}
ggplot(surface_counts_df, aes(x = Surface, y = Frequency, fill = Surface)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~Season, scales = "free") +
  labs(title = "Surface Frequencies for Each Season", x = "Surface", y = "Frequency") +
  theme_minimal()
```

Prvi histogram prikazuje raspodjelu mečeva prema podlogama u jesen. Uvjerljivo najviše mečeva u jesen održava se na tvrdoj podlozi. Dosta manje mečeva igra se na podlozi od tepiha, a nešto malo manje na zemlji. Najmanje mečeva u jesenskom dijelu sezone igra se na travi. 

Idući histogram prikazuje raspodjelu mečeva prema podlogama u proljeće. U proljetnom dijelu sezone uvjerljivo najviše teniskih mečeva igra se na podlozi od zemlje. Više od dvostruko manje mečeva održava se na tvrdoj podlozi. Jako malo mečeva održava se na podlozi od tepiha, a još manje na travi. 

U trećem histogramu promatramo raspodjelu mečeva prema podlogama tijekom ljeta. Najviše mečeva održava se na tvrdoj podlozi, zatim na travi pa na podlozi od zemlje. Svega nekoliko mečeva igra se na podlozi od tepiha. 

Zadnji histogram opisuje raspodjelu mečeva prema podlogama zimi. Tijekom zime prednjače mečevi na tvrdoj podlozi. Dosta manje mečeva igra se na zemlji, zatim na podlozi od tepiha te najmanje na travi.


## Zadatak 2. Postoji li značajna razlika u prosječnom broju dvostrukih pogrešaka između mečeva odigranih na otvorenom u odnosu na mečeve odigrane na zatvorenom terenu?
Prvo provjeravamo ukazuje li boxplot za moguću značajnu razliku.

```{r echo=FALSE}

t2 <- all_matches %>%
  filter(!is.na(w_df) & !is.na(l_df) & !is.na(surface) & w_df != "" & l_df != "" & surface != "")
t2 <- select(t2, w_df, l_df, surface)
t2$court_type <- ifelse(t2$surface %in% c("Clay", "Grass", "Hard"), "Outdoor", "Indoor")

t2 <- t2 %>%
  mutate(df = w_df + l_df)

open_surface_data <- t2$df[t2$court_type == 'Outdoor']
closed_surface_data <- t2$df[t2$court_type == 'Indoor']

min_length <- min(length(open_surface_data), length(closed_surface_data))
df <- data.frame(
        court_type = rep(c("Outdoor", "Indoor"), each = min_length),
        df = c(open_surface_data[1:min_length], closed_surface_data[1:min_length])
)

ggplot(df, aes(x = court_type, y = df)) +
        geom_boxplot(fill = "lightblue", color = "blue") +
        labs(title = "Comparison of Outdoor and Indoor Court Types",
             x = "Court Type",
             y = "Total DataFrame") +
        theme_minimal()
```

Grafički prikaz ukazuje na moguću razliku između prosječnog broja dvostrukih pogrešaka između mečeva
odigranih na otvorenom i zatvorenom. 
Kako bismo provjerili možemo li prihvatiti nultu hipotezu koja pretpostavlja da nema razlike, provest ćemo t-test.
Najprije moramo provjeriti pretpostavke o normalnoj distribuciji i homogenosti varijanci. Normalnu distribuciju prvo provjeravamo pomoću qq-plota, a zatim i Lilliefors testom.

```{r}
qqnorm(open_surface_data, main = "Normal Q-Q Plot for outdoor courts")
qqline(open_surface_data, col = "red", lwd = 2)


qqnorm(closed_surface_data, main = "Normal Q-Q Plot for indoor courts")
qqline(closed_surface_data, col = "blue", lwd = 2)

```

Iz qq-plota vidljivo je da distribucije nisu normalne niti za mečeve na otvorenom niti na zatvorenom jer postoji značajno odstupanje repa.
Zatim provodimo Lilliefors test: 

```{r}
lillie_test_outdoor <- lillie.test(open_surface_data)
lillie_test_indoor <- lillie.test(closed_surface_data)
```
```{r echo=FALSE}
print(lillie_test_outdoor)
print(lillie_test_indoor)
```

Za oba skupa podataka (otvoreni teren i zatvoreni teren), rezultati testova normalnosti (Lilliefors test) pokazuju da podaci nisu normalno distribuirani (p-vrijednosti su manje od 0.05) što se moglo zaključiti i iz grafova.

Provedimo F-test za provjeru homogenosti varijanci: 

```{r}
var_test_result <- var.test(open_surface_data, closed_surface_data)
print(var_test_result)
```

F-test za usporedbu varijanci pokazuje da postoji značajna razlika u varijancama između otvorenog terena i zatvorenog terena (p-vrijednost < 0.05).
Kako pretpostavke za t-test nisu zadovoljene koristimo Wilcoxonov test:

```{r}
print(wilcox.test(open_surface_data, closed_surface_data, alternative = "two.sided"))
```

Wilcoxon rank-sum test ne pokazuje značajnu razliku u srednjim vrijednostima (medijanama) između otvorenog i zatvorenog terena (p-vrijednost = 0.3191, dakle ne možemo odbaciti nultu hipotezu).

Na temelju ovih rezultata, možemo zaključiti da nema značajne razlike u prosječnom broju dvostrukih pogrešaka između mečeva odigranih na otvorenom terenu i mečeva odigranih na zatvorenom terenu.


## Zadatak 3. Ima li razlike u broju serviranih asova na različitim podlogama?	

Provjerimo za početak postoje li lako uočljive razlike u broju serviranih asova na različitim podlogama pomoću grafičkog prikaza.

```{r}
t3 <- all_matches %>%
  filter(!is.na(w_ace) & !is.na(l_ace) & !is.na(surface) & w_ace != "" & l_ace != "" & surface != "")
t3 <- select(t3, surface, w_ace, l_ace)
t3 <- t3 %>%
  mutate(aces = w_ace + l_ace)


boxplot(aces ~ surface, data = t3, 
        xlab = "Surface", ylab = "Number of Served Aces",
        main = "Boxplot of Served Aces by Surface")
```
Boxplot ukazuje na to da postoje razlike u broju asova s obzirom na podlogu. 

Nulta hipoteza jest da nema razlike u broju serviranih asova na različitim podlogama. Može li se odbaciti ista pokušat ćemo provjeriti ANOVA testom. ANOVA analizira razliku srednje vrijednosti između više od dvije grupe.
Kako bi taj test mogao biti korišten najprije moramo provjeriti jesu li zadovoljene pretpostavke:

1. provjera normalne distribucije

Prvo ćemo iscrtati histograme serviranih asova za svaku od površina:
```{r}
par(mfrow = c(2, 2))
for (surface in unique(t3$surface)){
hist(t3$aces[t3$surface==surface],
main = paste("Histogram of served aces on" , surface),
xlab = "Number of Served Aces",
ylab = "Frequency")
}
```

Histogrami ukazuju na to da distrubucija serviranih asova nije normalna niti na jednoj od podloga.
Normalna distribucija još se provjerava i Lilliefors testom:

```{r}
require(nortest)
print(lillie.test(t3$aces[t3$surface=='Hard']))
print(lillie.test(t3$aces[t3$surface=='Carpet']))
print(lillie.test(t3$aces[t3$surface=='Clay']))
print(lillie.test(t3$aces[t3$surface=='Grass']))
```

Za svaku od 4 podloge p-vrijednost je manja od 0.05 zbog čega odbacujemo pretpostavku da je distribucija normalna.

2. provjera homogenosti varijanci

Homogenost varijanci provjerava se Bartletttovim testom:
```{r}
bartlett.test(t3$aces ~ t3$surface)

```

P-vrijednost u Bartlettovom testu manja je od kritične vrijednosti od 0.05 čime se zaključuje da homogenost varijanci nije zadovoljena.

Isto se vidi i u ispisu varijance za svaku od podloga.
```{r}
var((t3$aces[t3$surface=='Hard']))
var((t3$aces[t3$surface=='Carpet']))
var((t3$aces[t3$surface=='Clay']))
var((t3$aces[t3$surface=='Grass']))
```
Kako niti jedna od pretpostavki nije zadovoljena koristit ćemo Kruskal-Wallis test, neparametarsku alternativu ANOVA testu.
```{r}
kruskal.test(aces~surface, data=t3)
```

Nakon provedenog testa dobivamo p-vrijednost manju od 0.05 što znači da možemo odbaciti nultu hipotezu, odnosno da postoji razlika u broj serviranih asova u odnosu na podlogu. Intuitivno ovaj rezultat ima smisla jer loptica ne odskače jednako od svih podloga, npr. na zemljanoj podlozi loptica se sporije odbija i obično zadržava niže dok se na travi odbija brzo.


## Zadatak 4. Kakva je veza između vrste terena i vjerojatnosti da će mečevi otići u peti set?

Postavljamo nultu hipotezu kako ne postoji statistički značajne veze između vrste terena i vjerojatnosti da će mečevi otići u peti set, a alternativna hipoteza sugerira prisutnost takve veze. Kako bismo testirali ovu hipotezu, koristit ćemo $\chi^2$ test. 

Najprije, provjeravamo pretpostavke kako bismo osigurali ispravnu primjenu testa. 

Omogućena je nezavisnost podataka jer rezultat jednog teniskog meča ne utječe na rezultat drugog meča. 

Također, osiguravamo da su nam podaci kategorički, klasifikacijom vrsta terena i ishoda mečeva u diskretne kategorije. 
Stvaramo kontingencijsku tablicu: 


```{r}
t4 <- all_matches[all_matches$best_of == 5, ]
t4$sets_played <- sapply(strsplit(as.character(t4$score), ""), function(x) sum(x == "-"))

contingency_table <- table(t4$surface, t4$sets_played == 5)
print(contingency_table)
```

Kontingencijskoj tablici dodajemo sume redaka i stupaca: 

```{r echo=FALSE}
contingency_with_sum = addmargins(contingency_table)
print(contingency_with_sum)
```

Još jedna pretpostavka testa je da očekivana frekvencija pojedinog razreda mora biti veća ili jednaka 5, stoga i to provjeravamo: 

```{r echo=FALSE}
for (col_names in colnames(contingency_with_sum)){
  for (row_names in rownames(contingency_with_sum)){
    if (!(row_names == 'Sum' | col_names == 'Sum') ){
      cat('Očekivane frekvencije za razred ',col_names,'-',row_names,': ',(contingency_with_sum[row_names,'Sum'] * contingency_with_sum['Sum',col_names]) / contingency_with_sum['Sum','Sum'],'\n')
    }
  }
}
```

Sve očekivane pretpostavke su zadovoljene, nastavljamo sa $\chi^2$ testom.

```{r}
chi_square_result <- chisq.test(contingency_table)
print(chi_square_result)
```

Rezultati $\chi^2$ testa ukazuju na to da ne postoji statistički značajna veza između vrste terena na kojem se održavaju teniski mečevi i vjerojatnosti da će mečevi otići u peti set (p-vrijednost = 0.361). S obzirom na p-vrijednost veću od 0.05, ne odbacujemo nultu hipotezu. 

## Zadatak 5. Možemo li procijeniti broj asova koje će igrač odservirati u tekućoj godini (zadnjoj dostupnoj sezoni) na temelju njegovih rezultata iz prethodnih sezona?	

Kako bismo predvidjeli broj asova za nekog igrača prvo moramo sagledati koje bi sve značajke mogle utjecati na broj odserviranih asova:

-   Visina igrača
-   Starost igrača
-   Rank igrača
-   Broj servi u sezoni
-   Broj uspješnih prvih servi
-   Broj osvojenih prvih servi

S obzirom da se podatci odnose pojedinačne mečeve, potrebno ih je agregirati za svakog igrača na razini sezone. Prilikom agregacije uzet ćemo srednju vrijednost za starost i rank igrača dok ćemo ostale statistike o servi sumirati. Kako bi dobili dojam o odnosu ovih varijabli i broja asova prikazat ćemo ih pojedinačno grafički pomoću scatter plota.

```{r echo=FALSE}

# Create a new dataframe with selected features
features <- c("tourney_id", "winner_id", "loser_id", "winner_name", "loser_name", "w_ace", "l_ace", "winner_ht", "loser_ht", "winner_age", "loser_age", "w_1stIn", "l_1stIn", "w_svpt", "l_svpt", "w_svpt", "l_svpt", "w_1stWon", "l_1stWon", "winner_rank", "loser_rank")

aces.by.season <- all_matches %>% select(all_of(features))
aces.by.season <- na.omit(aces.by.season)

# Extract the year from the tourney_id
aces.by.season$year <- as.numeric(substring(aces.by.season$tourney_id, 1, regexpr("-", aces.by.season$tourney_id)-1))

drop <- c("tourney_id")
aces.by.season = aces.by.season[,!(names(aces.by.season) %in% drop)]

# Aggregate features by player and year, considering both winner and loser information
winner.aggregated.data <- aces.by.season %>%
  group_by(player_id = winner_id, name = winner_name, year, winner_ht) %>%
  summarize(
    aces = sum(w_ace),
    age = mean(winner_age),
    rank = mean(winner_rank),
    firstIn = sum(w_1stIn),
    firstWon = sum(w_1stWon),
    svpt = sum(w_svpt),
    .groups = 'drop'
  )

loser.aggregated.data <- aces.by.season %>%
  group_by(player_id = loser_id, name = loser_name, year, loser_ht) %>%
  summarize(
    aces = sum(l_ace),
    age = mean(loser_age),
    rank = mean(loser_rank),
    firstIn = sum(l_1stIn),
    firstWon = sum(l_1stWon),
    svpt = sum(l_svpt),
    .groups = 'drop'
  )

colnames(winner.aggregated.data)[colnames(winner.aggregated.data) == "winner_ht"] <- "height"
colnames(loser.aggregated.data)[colnames(loser.aggregated.data) == "loser_ht"] <- "height"

wl.aggregated.data <- rbind(winner.aggregated.data, loser.aggregated.data)

aces.by.season <- wl.aggregated.data %>%
  group_by(player_id, name, year, height) %>%
  summarize(
    aces = sum(aces),
    age = mean(age),
    rank = mean(rank),
    firstIn = sum(firstIn),
    firstWon = sum(firstWon),
    svpt = sum(svpt),
    .groups = 'drop'
  )

aces.by.season$invRank <- 1 / aces.by.season$rank
```

```{r scatter plots}

plot(aces.by.season$height, aces.by.season$aces)

hist(aces.by.season$height)

plot(aces.by.season$age, aces.by.season$aces)

hist(aces.by.season$age)

plot(aces.by.season$rank , aces.by.season$aces)

plot(aces.by.season$svpt, aces.by.season$aces)

plot(aces.by.season$firstIn, aces.by.season$aces)

plot(aces.by.season$firstWon, aces.by.season$aces)
```
Starost i visina igrača naizgled imaju nelinearni odnos prema broju aseva. Međutim, ako ispišemo histograme starosti i visina vidimo da je taj odnos proizašao iz frekvencije pojavljivanja tih značajki. Ovo ne vrijedi u potpunosti za visine igrača, ali pokazalo se da visina nije znatno utjecala na točnost modela. Zbog toga te dvije značajke nećemo dalje uzimati u obzir.

Rank igrača ima snažan obrnuto proporcionalan odnos s brojem asova što intuitivno ima smisla. Bolji igrači će imati veći broj asova. Važno je uočiti da ovaj odnos nije linearan i te ćemo morati uzeti inverz ranka prilikom regresije.

Ukupan broj servi, prvih uspješnih i prvih osvojenih servi ima linearan odnos prema broju aseva. Također uočavamo da su ove tri značajke naizgled jako korelirane. To ćemo morati ispitati i po potrebi uzeti samo jedno od ovih značajki za našu regresiju.

Valja spomenuti da su u obzir još bili uzeti podatci o servama, ali u postotcima. Oni su imali sličan problem kao i starost i visina. Scatter plot u odnosu na broj asova je imao oblik normalne distribcije. Dominantna ruka također nije uzeta u obzir jer prednost koju ona donosi ovisi o dominantnoj ruci suparnika, a pošto su podatci agregirani prednosti i hendikepi dominantne ruke će se poništiti.

Provjerit ćemo naše pretpostavke koristeći model jednostavne regresije, po jedan za svaku značajku. Broj asova će biti zavisna varijabla

```{r jendostavna regresija}
fit.invRank = lm(aces ~ invRank, data=aces.by.season)

fit.svpt = lm(aces ~ svpt, data=aces.by.season)

fit.firstIn = lm(aces ~ firstIn, data=aces.by.season)

fit.firstWon = lm(aces ~ firstWon, data=aces.by.season)

f = function(x, coeffs)
  return(coeffs[[1]] + + coeffs[[2]] * (1 / x))
plot(aces.by.season$rank, aces.by.season$aces)
curve(f(x, fit.invRank$coefficients), add = TRUE, col = "red")

plot(aces.by.season$svpt, aces.by.season$aces)
lines(aces.by.season$svpt , fit.svpt$fitted.values, col='red')

plot(aces.by.season$firstIn, aces.by.season$aces)
lines(aces.by.season$firstIn, fit.firstIn$fitted.values, col='red')

plot(aces.by.season$firstWon, aces.by.season$aces)
lines(aces.by.season$firstWon, fit.firstWon$fitted.values, col='red')
```
### Normalnost reziduala i homogenost varijance

Normalnost reziduala provjerit ćemo grafički pomoću histograma i qq plota te statistički pomoću Lillieforsovog testa.

```{r normalnost reziduala}
# Normalnost reziduala za inverzni rank
plot(fit.invRank$residuals)

hist((fit.invRank$residuals))
hist(rstandard(fit.invRank))

qqnorm(rstandard(fit.invRank))
qqline(rstandard(fit.invRank))

plot(fit.invRank$fitted.values, fit.invRank$residuals)
plot(aces.by.season$year , fit.invRank$residuals)

lillie.test(rstandard(fit.invRank))

# Normalnost za broj osvojenih prvih servi, skoro identični rezultati i za
# ukupan broj servi i uspješnih prvih servi
plot(fit.firstWon$residuals)

hist((fit.firstWon$residuals))
hist(rstandard(fit.firstWon))

qqnorm(rstandard(fit.firstWon))
qqline(rstandard(fit.firstWon))

plot(fit.firstWon$fitted.values, fit.firstWon$residuals)
plot(aces.by.season$year , fit.firstWon$residuals)

lillie.test(rstandard(fit.firstWon))
```

Iz histograma i qq plota možemo zaključiti da reziduali ukupan broja servi, uspješnih prvih servi i osvojenih prvih servi značajno odstupaju ali nalikuju na normalno distribuciju dok za inverz ranka reziduali više nalikuju eksponencijalnoj distribuciji nego normalnoj.

Također treba prijetiti da za ukupan broj servi, uspješnih prvih servi i osvojenih prvih servi u ovisnosti o predviđanjima reziduali pokazuju heterogenost varijance, šire se povećanjem $\hat{y}$. Međutim u ovisnosti o godinama reziduali pokazuju homogenu varijancu.

### Korelacija značajki

Unatoč neobećavajućim rezultatima ispitaivanja normalnosti i homogenosti varijance reziduala pokušat ćemo napraviti regresiju nad skupom relevantnih značajki. Kako bi to napravili prvo moramo odrediti koje su značajke korelirene.

```{r korelacija znacajki}
cor(cbind(aces.by.season$aces, aces.by.season$invRank, aces.by.season$svpt, aces.by.season$firstIn, aces.by.season$firstWon))
```

Kao što smo i pretpostavili ranije, ukupan broj servi, uspješnih prvih servi i osvojenih prvih servi pokasuzuju snažnu pozitivnu korelaciju. Stoga ćemo od te tri značjke uzeti samo ukupan broj osvojenih prvih srevi jer ima najveću korelaciju s brojem asova od te tri.

Inverzni rank također pokazuje značajnu korelaciju s ostatkom značajki.

```{r multi}
fit.multi = lm(aces ~ invRank + firstWon, data=aces.by.season)
summary(fit.multi)
```
Iz modela možemo vidjeti da rank igrača jako slabo utječe na objašnjavanje varijance podataka. Stoga ćemo pokušati pretvoriti rank igrača u kategoričku varijablu na način da svrtamo igrače u sljedeće kategorije:
  - Rank   1 -  20
  - Rank  21 -  50
  - Rank  50 - 100
  - Rank 100+
  
```{r categoric rank}
aces.by.season <- aces.by.season %>%
  mutate(rankCat = case_when(
    rank < 25 ~ 1,
    rank < 50 ~ 2,
    rank < 75 ~ 3,
    rank < 100 ~ 4,
    TRUE ~ 5
  ))

boxplot(aces~rankCat, data=aces.by.season)
```

```{r rank category model}
aces.by.season.d = dummy_cols(aces.by.season, select_columns = 'rankCat')

fit.multi.d = lm(aces ~ firstWon + rankCat_1 + rankCat_2 + rankCat_3 + rankCat_4, data = aces.by.season.d)
summary(fit.multi.d)
```
Ova metoda nažalost također nije dala nikakvo značajno poboljšanje. Međutim postoji još jedan način da poboljšamo rezultate a to je uvođenje nove zakašnjele varijable. Naime pretpostavljamo da će broj aseva za nekog igrača biti jako povezan s brojem aseva koje je ostavrio u prošloj sezoni. Zato ćemo uvesti novu značajku prevAces u naš model.

```{r prevAces}
aces.by.season.d$prevAces = c(NA, aces.by.season.d$aces[1:length(aces.by.season.d$aces)-1])

fit.multi.timelag = lm(aces ~ firstWon + rankCat_1 + rankCat_2 + rankCat_3 + rankCat_4 + prevAces, data = aces.by.season.d)
summary(fit.multi.timelag)
```
Ovime smo dobili osjetno bolji model. Za kraj ćemo još primjeniti model za nekoliko igrača da vidimo kako radi.

```{r example}
player.samples <- aces.by.season.d[sample(nrow(aces.by.season.d), 10),]

name <- player.samples$name
year <- player.samples$year
target_aces <- player.samples$aces
prediction_aces <- predict(fit.multi.timelag, newdata = player.samples)

print(data.frame(name, year, target_aces, prediction_aces))
```

Model na žalost ne radi sjajno, ali to je i za očekivati jer su narušeni uvjeti normalnosti i homogenosti varijanci reziduala. Za ovaj problem potreban je složeniji model.